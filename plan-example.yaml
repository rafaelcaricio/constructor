# configuration example
#
# This files shows examples how to configure 'constructor' to do its job. This is most likely generated by a CI system
# and rarely written manually.
#

# the amount of resources the build will need
resources:
  cpus: 2
  memory: 4096  # in MB
  disk: 3G

# any job can have a list of inputs that get fetched before any task execution is done
input:

  - type: "git"
    source: "git@git.example.org:myapp"
    head: "f1d2d2f924e986ac86fdf7b36c94bcdf32beec15"
    # if source is 'ssh', this needs to be the SSH key; if source is 'http', this needs to be an access token
    # this file needs to exist in the constructor Docker container
    secret: "/secrets/mygitkey"
    # the place where the input will be found in the construction site
    target: "/work/myapp"


# a list of OS packages that should be installed prior to work command executions
packages:
  - maven
  - build-essentials

# after all inputs are fetched and transferred into the construction site, these commands are executed in order
# if one fails, everything stops immediately
work:

  - cwd: "/input/myapp"
    command: "mvn package"
    environment:
      "VERSION": "1.0"
    root: false

  - cwd: "/input/myapp"
    command: "./gen-docs.sh"
    root: false

# after all work is done, collect the results and push to target locations
output:

  - type: Docker
    # how the Docker image is called in the construction site after build
    source: "mybuild"
    # how the Docker image needs to be named to be properly pushed
    target: "myorg/mybuild:1.0"
    # a file that contains the Docker registry password; this file needs to be present in the constructor Docker container
    secret: "/secrets/myregistry"

  - type: Maven
    # where to find the built Java archives
    jar: "/work/myapp/target/myapp-1.0.jar"
    jar-doc: "/work/myapp/target/myapp-1.0-javadoc.jar"
    # the key to sign the artifacts; needs to be available in the constructor Docker container
    signing-key: "/secrets/gpg-key"
    # where to upload the artifacts to; 'target' is optional and defaults to Maven Central
    target: "nexus.example.org"
    # where to find the password for the registry upload; this file needs to be present in the constructor Docker container
    secret: "/secrets/maven-password"

  # TODO support 'npm', 'gem', 'pypi', ...