#apiVersion: batch/v1  # TODO soon... (K8s 1.5+)
apiVersion: extensions/v1beta1
kind: Job
metadata:
  name: constructor
spec:
  template:

    metadata:
      annotations:

        constructionConfig:
          input:
            - type: "git"
              source: "https://github.com/sarnowski/constructor.git"
              head: "master"
              target: "/build"

          packages:
            - docker.io
            - make

          work:
            - cwd: "/build"
              command: "make"

          output:
            - type: Docker
              source: "constructor"
              target: "sarnowski/constructor"
              secret: "/secrets/dockerhub"

    containers:
      - name: worker
        image: sarnowski/constructor:latest
        volumeMounts:
          - name: config
            mountPath: /config
            readOnly: false

    volumes:
      - name: config
        downwardAPI:
          items:
            - path: "annotations"
              fieldRef:
                fieldPath: metadata.annotations

# TODO add secret volumes